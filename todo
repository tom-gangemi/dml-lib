- [x] Database.DmlOptions options to pass 
    â€” [x] support a global default (uow.options(opts)) 
    - [ ] support per-operation override (.withOptions(perOpOpts))
- [x] Fluent Bulk records update without the loop e.g.
    - [x] DML.Records(opportunities).with(Opportunity.Status, 'Closed Won') â€” loop-free builder that batches field patches, applies FLS (per mode), then registers the op.
- [ ] Bulk DMLs â€” group by SObjectType and operation; execute in chunked batches (default 200) to minimize statements and respect limits.
- [ ] when the same record is added with the same id, avoid duplication, apply for update and upser
- [ ] Savepoint + rollback â€” wrap commitWork() in a savepoint; 
    - [x] on error rollback everything;
    - [ ] clear internal state afterward.
- [ ] General and per-operation overrides e.g. new DML(options), registerInsert(..., options) 
- [ ] allow allOrNone, DMLOptions, and SecurityMode per op; merge overrides over UoW defaults.
- [x] Update list of records at once e.g accounts.with(Account.Unit, 'test') - DML.Records(records).with(field, value)
- [x] Static DML eg. DML.Global.toInsert(); DML.Global.commitWork(); DML.Shared.toInsert();
- [x] Field-Level Security
    - [x] USER_MODE â€” enforce CRUD/FLS strictly; fail on violations with clear errors.
    - [x] SYSTEM_MODE â€” skip CRUD/FLS checks (still subject to validation rules)
    - [ ] stripInaccessible (?) â€” SANITIZE mode: apply Security.stripInaccessible(CREATABLE/UPDATABLE, records); record stripped fields in results.
- [ ] Upsert with external ID field â€” .toUpsert(record, externalIdField) or DML.Record(record).withExternalId(field)
- [ ] Configurable Sharing Mode
    - [x] Inherited sharing by default â€” keep DML.cls as inherited sharing
    - [x] with sharing
    - [x] without sharing
    - [ ] Sharing mode configurable per operation (?)
- [x] Relationships
    - [x] Deferred relationship resolution â€” resolve lookups just-in-time during commit (like fflib), not at registration time.
    - [x] Automatic dependency ordering â€” parents insert before children; deletes child-first; derive order from relationships if not explicit.
- [ ] Preview mode or debug mode (?) - dry-run uow.preview() shows per-type op counts, fields to mutate, effective chunk size/allOrNone/security mode, and pending relationships; no DML.
- [ ] Retry strategy â€” optional, 
    - [ ] bounded retry on UNABLE_TO_LOCK_ROW, 
    - [ ] splitting chunks when retried; record retry trace in results.
    - [ ] Chunk size
```java
dml.withRetryPolicy(new RetryPolicy()
  .maxAttempts(3)
  .initialDelayMs(25)  
  .splitOnRetry(true)); // split chunk into smaller pieces when retrying
```
- [ ] Mocking
    - [x] Mock Ids â€” generator produces valid 18-char Ids with correct key prefix; assign only in fake provider.
    - [x] Registry of number of inserted records â€” per type & per batch counters.
    - [ ] Registry of issued DML for each operation â€” capture exact batches for insert/update/upsert/delete/etc.
    - [ ] DML Counter â€” total DML statements and rows processed; expose via results.
    - [ ] Mock Errors - mock different DML errors.
    - [ ] Update/Upsert should update record reference
```java
    DML.mock('mockId').mockAll();
    DML.mock('mockId').mockInsert();
    DML.mock('mockId').mockUpdate();

    DML.get('mockId').getInserted(Account.SObjectType);
    DML.get('mockId').getUpdated(Account.SObjectType);
```
- [ ] Supported Operations:
    - [x] insert
    - [x] update
    - [x] upsert
    - [x] delete
    - [x] undelete
    - [x] publish event
    - [ ] hardDelete (delete + Database.emptyRecycleBin)
    - [ ] merge (Database.merge â†’ MergeResult[])
    - [ ] convertLead (Database.convertLead â†’ LeadConvertResult[])
- [x] Return Database.Result or some other wrapper â€” return UowResult with per-op DmlOutcome, raw SaveResult[]/DeleteResult[]/MergeResult[], limits snapshot, events, retries.
- [ ] Commit hooks - `DML.Hook`
    - [x] Before commit hook â€” pure in-memory prep (e.g., finalize patches) before any DML.
    - [x] After commit hook â€” enqueue async work / notifications; fires only if commit succeeds.
    - [ ] before hook should got the list of records to be inserted
    - [x] after hook should get the results
- [ ] 100% code coverage â€” tests for happy/error paths, CRUD/FLS modes, DmlOptions, chunking, lock-retry, preview, hooks, mocking registries, and relationship ordering.
- [ ] Trigger bypass adapter(optional) â€” new apex class DML.Bypass interface that will get sobjectType and based on it can have logic to bypass different triggers
- [ ] Chunk Size â€” protect against DML row/CPU limits. uow.withChunkSize(200) (default 200) to mimic trigger batch sizes and reduce recursion; auto-downshift on retries if enabled.
- [x] Rich result model (optional) â€” include outcomes, limits, stripped fields, warnings, event results, and retry trace; provide toJson() for logging.
```java
DML.SaveResult {
    // copy Database.SaveResult
}

class DmlOutcome {
  public SObjectType type;
  public Operation op;                 // INSERT/UPDATE/UPSERT/DELETE/UNDELETE/HARDDELETE/MERGE/EVENT
  public Integer requested;
  public Integer succeeded;
  public Database.SaveResult[] saveResults; // or DeleteResult/MergeResult
  public Database.Error[] errors;           // flattened
  public Long durationMs;
  public Boolean partial;                   // allOrNone=false and some failed
}

class UowResult {
  public Boolean success;
  public Map<SObjectType, Map<Operation, DmlOutcome>> byTypeOp;
  public Map<Id, Id> idMap;                 // tempâ†’real (if you generate mock Ids)
  public LimitsSnapshot limits;             // statements, rows, CPU
  public List<EventOutcome> events;         // publish results
  public List<RetryEvent> retries;          // lock retry trace
}
```
- [x] discardWork() â€” clear all pending operations without committing.
- [x] Clear internal state after commitWork() â€” prevent re-commit of same operations.
- [ ] Query operations â€” query(), countQuery(), getQueryLocator(), getCursor() with same access/sharing mode.
- [ ] Connector to SOQL Lib â€” inject selectors for reads; honor chosen sharing mode.
- [x] Dedupling registration â€” when records with the same Id are registered and modify the same field: policy LAST_WINS | THROW; track warnings when deduping occurs.
- [ ] Observability hooks â€” uow.withLogger(ILogger) to emit timings, limits, retries, per-op summaries; keep lightweight to avoid CPU spikes.
- [ ] DML optimization
    - [ ] Minimize DML statements â€” batch same-type operations.
    - [x] Build dependency graph â€” derive parent/child order from registered relationships.
- [x] insertImmediately, updateImmediately, etc.
- [ ] Email integration â€” toSendEmail(Messaging.Email) sent during commit.
- [ ] Custom work (IDoWork) â€” registerWork(DML.Work) for custom logic during commit.

---

```java
DML.systemMode();

DML.Insert.add();

DML.Update.userMode().add();

DML.Delete.userMode().add();

DML.commitWork();

DML dml = new DML();

dml.toInsert(record);

DML.Commitable db = new DML();

```

- [ ] flat intefrace
```
public interface Result {
		List<OperationResult> all();
		// Per Operation
		List<OperationResult> inserted();
		List<OperationResult> updated();
		List<OperationResult> upserted();
		List<OperationResult> deleted();
		List<OperationResult> undeleted();
		List<OperationResult> published();
		// Per Object Type
		OperationResult inserted(Schema.SObjectType objectType);
		OperationResult updated(Schema.SObjectType objectType);
		OperationResult upserted(Schema.SObjectType objectType);
		OperationResult deleted(Schema.SObjectType objectType);
		OperationResult undeleted(Schema.SObjectType objectType);
		OperationResult published(Schema.SObjectType objectType);
		// Failures
		Boolean hasFailures();
		List<RecordResult> failures();
        failures() {
		if (allOrNone == false) {
			throw new DmlException('All or none is true');
		}
	}
	}
    ```

- [ ] Mock better

```
public interface Mockable {
		void allDmls();
		// Per Operation
		Mockable allInserts();
		Mockable allUpdates();
		Mockable allUpserts();
		Mockable allDeletes();
		Mockable allUndelete();
		Mockable allPublishes();
		// Per Operation Per Object Type
		Mockable allInsertsFor(SObjectType objectType);
		Mockable allUpdatesFor(SObjectType objectType);
		Mockable allUpsertsFor(SObjectType objectType);
		Mockable allDeletesFor(SObjectType objectType);
		Mockable allUndeleteFor(SObjectType objectType);
		Mockable allPublishesFor(SObjectType objectType);
		// 
		then(CustomMocabke)
		// Per Operation
		// MockableOperation onInsert();
		// MockableOperation onUpdate();
		// MockableOperation onUpsert();
		// MockableOperation onDelete();
		// MockableOperation onUndelete();
		// MockableOperation onPublish();
	}

	public interface CustomMockable {
		Result execute(List<SObject> records);
	}
		

	public interface MockableOperation {
		MockableOperation forType(SObjectType objectType);
		matchRecord(SObject record);
		MockableOperation throwDmlException();
		MockableOperation throwDmlException(String message);
		MockableOperation throwDmlException(String message, System.StatusCode statusCode);
		MockableOperation throwDmlException(String message, System.StatusCode statusCode, List<String> fields);
	}

```

---

## Priority Matrix

| Priority | Feature | Effort | Impact |
|----------|---------|--------|--------|
| ðŸ”´ Critical | Deferred Relationship Resolution | High | Very High |
| ðŸ”´ Critical | Automatic Dependency Ordering | High | Very High |
| ðŸ”´ Critical | Merge Operations | Medium | High |
| ðŸ”´ Critical | Hard Delete | Low | Medium |
| ðŸ”´ Critical | Discard Work | Low | Medium |
| ðŸŸ¡ Important | Upsert with External ID | Medium | High |
| ðŸŸ¡ Important | Lead Conversion | Medium | Medium |
| ðŸŸ¡ Important | Per-Operation Overrides | High | High |
| ðŸŸ¡ Important | Email Integration | Medium | Medium |
| ðŸŸ¡ Important | Custom Work (IDoWork) | Low | Medium |
| ðŸŸ¢ Nice | Better Mock API with Errors | Medium | Medium |
| ðŸŸ¢ Nice | Retry Strategy | High | Medium |
| ðŸŸ¢ Nice | Chunk Size | Medium | Medium |
| ðŸŸ¢ Nice | Query Integration | Medium | Low |
| ðŸŸ¢ Nice | Lifecycle Hooks | Medium | Low |

To hard delete.

toHardDelete(Id recordId);
toHardDelete(SObject record);
toHardDelete(Iterable<Id> recordIds);
toHardDelete(List<SObject> records);

		Account account1 = new Account(Name = 'Account 1');
		Contact contact1 = new Contact(LastName = 'Contact 1');
		Opportunity opportunity1 = new Opportunity(Name = 'Opportunity 1', StageName = 'Discovery', CloseDate = System.today());

		new DML()
			.toInsert(DML.Record(opportunity1)
				.withRelationship(Opportunity.AccountId, account1)
				.withRelationship(Opportunity.Contact__c, contact1)
			)
			.toInsert(DML.Record(contact1).withRelationship(Contact.AccountId, account1))
			.toInsert(DML.Record(account1).withRelationship(Account.Contact__c, contact1))
			.commitWork();


--- 

Status | Priority | Feature | Effort | Impact |
|------|----------|---------|--------|--------|
| [x]  | ðŸ”´ Critical | Deferred Relationship Resolution | High | Very High |
| [x]  | ðŸ”´ Critical | Automatic Dependency Ordering | High | Very High |
| [x]  | ðŸ”´ Critical | Merge Operations | Medium | High |
| [x]  | ðŸ”´ Critical | Hard Delete | Low | Medium |
| [x]  | ðŸ”´ Critical | Discard Work | Low | Medium |
| [x]  | ðŸŸ¡ Important | Upsert with External ID | Medium | High |
| [ ]  | ðŸŸ¡ Important | Lead Conversion | Medium | Medium |
| [ ]  | ðŸŸ¡ Important | Per-Operation Overrides | High | High |
| [ ]  | ðŸŸ¡ Important | Email Integration | Medium | Medium |
| [ ]  | ðŸŸ¡ Important | Custom Work (IDoWork) | Low | Medium |
| [x]  | ðŸŸ¢ Nice | Dedupling registration | Medium | Medium |
| [ ]  | ðŸŸ¢ Nice | Better Mock API with Errors | Medium | Medium |
| [ ]  | ðŸŸ¢ Nice | Add operation hashCode to OperationResult | Medium | Medium |
| [ ]  | ðŸŸ¢ Nice | Retry Strategy | High | Medium |
| [ ]  | ðŸŸ¢ Nice | Chunk Size | Medium | Medium |
| [ ]  | ðŸŸ¢ Nice | Query Integration | Medium | Low |
| [x]  | ðŸŸ¢ Nice | Lifecycle Hooks | Medium | Low |


`sf org create scratch -a dml-lib -f './config/project-scratch-def.json' -d --duration-days 30 --target-dev-hub beyondthecloud-devhub`